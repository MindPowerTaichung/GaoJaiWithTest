<script>
    //類別
    var cat_apiUrl = "api/catCustomers";
    var cat_dataSource = new kendo.data.DataSource({
        transport: {
            read: {
                url: cat_apiUrl,
                dataType: "json"
            }
        },
        error: function (err) {
            var message = (err.xhr.responseText == "") ? "" : JSON.parse(err.xhr.responseText).message + "\n";
            alert(err.status + "\n" + message + "將重新載入資料!");
            console.log(err.status + "\n" + message + "將重新載入資料!");
        },
        schema: {
            model: {
                id: "id",
                fields: {
                    no: { editable: true },
                    name: { editable: true },
                    timestampString: { editable: false }
                }
            }
        }
    });
    //收付款條件
    var pay_apiUrl = "api/catPays";
    var pay_dataSource = new kendo.data.DataSource({
        transport: {
            read: {
                url: pay_apiUrl,
                dataType: "json"
            }
        },
        error: function (err) {
            var message = (err.xhr.responseText == "") ? "" : JSON.parse(err.xhr.responseText).message + "\n";
            alert(err.status + "\n" + message + "將重新載入資料!");
            console.log(err.status + "\n" + message + "將重新載入資料!");
        },
        schema: {
            model: {
                id: "id",
                fields: {
                    no: { editable: true },
                    name: { editable: true },
                    timestampString: { editable: false }
                }
            }
        }
    });
    //幣別
    var currency_apiUrl = "api/catCurrencies";
    var currency_dataSource = new kendo.data.DataSource({
        transport: {
            read: {
                url: currency_apiUrl,
                dataType: "json"
            }
        },
        error: function (err) {
            var message = (err.xhr.responseText == "") ? "" : JSON.parse(err.xhr.responseText).message + "\n";
            alert(err.status + "\n" + message + "將重新載入資料!");
            console.log(err.status + "\n" + message + "將重新載入資料!");
        },
        schema: {
            model: {
                id: "id",
                fields: {
                    no: { editable: true },
                    name: { editable: true },
                    timestampString: { editable: false }
                }
            }
        }
    });
    function telQuery()
    {
        //debugger;
        //$('#gridCustomers').data('kendoGrid').dataSource.transport.options.read.url = customersViewPhone_apiUrl + "/" + $("#strTEL").val();
        customersView_dataSource.transport.options.read.url = customersViewPhone_apiUrl + "/" + $("#strTEL").val();
        $('#gridCustomers').data('kendoGrid').dataSource.read();
        $('#gridCustomers').data('kendoGrid').refresh();
    }
</script>
    <div id="telSearch" class="section-box">
    <table>
        <tr>
            <td>
                電話查詢：
            </td>
            <td>
            <td>
                <input id="strTEL" name="strTEL" style="width:150px" />
            </td>
            <td>
                <input id="TELquery" type="button" value="搜尋" style="width:50px" onclick="telQuery()" />
            </td>
        </tr>
    </table>
</div>
<style>
    .section-box {
        margin-top: 20px;
        padding: 10px;
        -moz-box-shadow: 0 1px 2px rgba(0,0,0,0.45), inset 0 0 30px rgba(0,0,0,0.07);
        -webkit-box-shadow: 0 1px 2px rgba(0,0,0,0.45), inset 0 0 30px rgba(0,0,0,0.07);
        box-shadow: 0 1px 2px rgba(0,0,0,0.45), inset 0 0 30px rgba(0,0,0,0.07);
        -webkit-border-radius: 8px;
        -moz-border-radius: 8px;
        border-radius: 8px;
    }
</style>

    <div id="gridCustomers"></div>

<style type="text/css">
    .k-edit-form-container {
        width: 900px;
        margin-left: 10px;
    }

    .k-edit-form-container .k-edit-label {
        width: 150px;
        vertical-align:bottom;
        font-size:medium;
    }
    .k-edit-form-container .k-textbox {
    width: 250px;
    }

</style>
<script id="popup-editor" type="text/x-kendo-template">
    <table id="teamEditor">
        <tr>
            <td>
                <div class="k-edit-label">
                    <label for="cat">類別：</label>
                </div>
            </td>
            <td><input data-role="dropdownlist" data-source="cat_dataSource" data-text-field="name" data-value-field="id" name="cat" style="width: 90px;" data-bind="value:cat" /></td>
            <td>
                <div class="k-edit-label">

                </div>
            </td>
            <td></td>
        </tr>
        <tr>
            <td>
                <div class="k-edit-label">
                    <label for="no">編號:&nbsp;</label>
                </div>
            </td>
            <td><input type="text" id="no" class="k-input k-textbox" data-bind="value:no" name="no" required /></td>
            <td>
                <div class="k-edit-label">
                    <label for="name">名稱:&nbsp;</label>
                </div>
            </td>
            <td><input type="text" id="name" class="k-input k-textbox" data-bind="value:name" name="name" required />
                <input id="id" name="id" style="display: none;" data-bind="value:id" />
            </td>
        </tr>
        <tr>
            <td>
                <div class="k-edit-label">
                    <label for="sname">簡稱:&nbsp;</label>
                </div>
            </td>
            <td><input type="text" id="sname" class="k-input k-textbox" data-bind="value:sname" name="sname" required /></td>
            <td>
                <div class="k-edit-label">
                    <label for="unid">統一編號:&nbsp;</label>
                </div>
            </td>
            <td><input type="text" id="unid" class="k-input k-textbox" data-bind="value:unid" /></td>
        </tr>
        <tr>
            <td>
                <div class="k-edit-label">
                    <label for="telephone1">公司電話:&nbsp;</label>
                </div>
            </td>
            <td><input type="text" id="telephone1" class="k-input k-textbox" data-bind="value:telephone1" /></td>
            <td>
                <div class="k-edit-label">
                    <label for="fax">公司Fax:&nbsp;</label>
                </div>
            </td>
            <td><input type="text" id="fax" class="k-input k-textbox" data-bind="value:fax" /></td>
        </tr>
        <tr>
            <td>
                <div class="k-edit-label">
                    <label for="email1">公司Email:&nbsp;</label>
                </div>
            </td>
            <td><input type="text" id="email1" class="k-input k-textbox" data-bind="value:email1" /></td>
            <td>
                <div class="k-edit-label">
                    <label for="website">公司網站:&nbsp;</label>
                </div>
            </td>
            <td><input type="text" id="website" class="k-input k-textbox" data-bind="value:website" /></td>
        </tr>
        <tr>
            <td>
                <div class="k-edit-label">
                    <label for="address">公司地址:&nbsp;</label>
                </div>
            </td>
            <td><input type="text" id="address" class="k-input k-textbox" data-bind="value:address" /></td>
            <td>
                <div class="k-edit-label">
                    <label for="shipaddr">送貨地址:&nbsp;</label>
                </div>
            </td>
            <td><input type="text" id="shipaddr" class="k-input k-textbox" data-bind="value:shipaddr" /></td>
        </tr>
        <tr>
            <td>
                <div class="k-edit-label">
                    <label for="invoiceaddr">發票地址:&nbsp;</label>
                </div>
            </td>
            <td><input type="text" id="invoiceaddr" class="k-input k-textbox" data-bind="value:invoiceaddr" /></td>
            <td>
                <div class="k-edit-label">
                    <label for="contact1">負責人:&nbsp;</label>
                </div>
            </td>
            <td><input type="text" id="contact1" class="k-input k-textbox" data-bind="value:contact1" name="contact1" required /></td>
        </tr>
        <tr>
            <td>
                <div class="k-edit-label">
                    <label for="telephone2">負責人電話:&nbsp;</label>
                </div>
            </td>
            <td><input type="text" id="telephone2" class="k-input k-textbox" data-bind="value:telephone2" /></td>
            <td>
                <div class="k-edit-label">
                    <label for="email2">負責人Email:&nbsp;</label>
                </div>
            </td>
            <td><input type="text" id="email2" class="k-input k-textbox" data-bind="value:email2" /></td>
        </tr>
        <tr>
            <td>
                <div class="k-edit-label">
                    <label for="contact2">聯絡人:&nbsp;</label>
                </div>
            </td>
            <td><input type="text" id="contact2" class="k-input k-textbox" data-bind="value:contact2" /></td>
            <td>
                <div class="k-edit-label">
                    <label for="telephone3">聯絡人電話:&nbsp;</label>
                </div>
            </td>
            <td><input type="text" id="telephone3" class="k-input k-textbox" data-bind="value:telephone3" /></td>
        </tr>
        <tr>
            <td>
                <div class="k-edit-label">
                    <label for="pay">付款條件:&nbsp;</label>
                </div>
            </td>
            <td><input data-role="dropdownlist" data-source="pay_dataSource" data-text-field="name" data-value-field="id" name="pay" style="width: 150px;" data-bind="value:pay" /></td>
            <td>
                <div class="k-edit-label">
                    <label for="currency">交易幣別:&nbsp;</label>
                </div>
            </td>
            <td><input data-role="dropdownlist" data-source="currency_dataSource" data-text-field="name" data-value-field="id" name="currency" style="width: 100px;" data-bind="value:currency" /></td>
        </tr>
        <tr>
            <td>
                <div class="k-edit-label">
                    <label for="note">備註:&nbsp;</label>
                </div>
            </td>
            <td colspan="3"><textarea name="note" cols="60" rows="5"></textarea></td>
        </tr>
    </table>
</script>
<script type="text/x-kendo-template" id="detailtemplate">
    <table class="k-grid table">
        <tr>
            <td class="tdTitle01" style="width:70px" align="center">
                類別
            </td>
            <td class="tdContent01">
                #= (catName == null) ? '' : catName #
            </td>
            <td class="tdTitle01" style="width:70px" align="center">

            </td>
            <td class="tdContent01">

            </td>
            <td class="tdTitle01" style="width:70px" align="center">
                廠商編號
            </td>
            <td class="tdContent01">
                #= (no == null) ? '' : no #
            </td>
            <td class="tdTitle01" style="width:90px" align="center">
                最後交易日
            </td>
            <td class="tdContent01">
                #= (lasttrade == null) ? '' : kendo.toString(kendo.parseDate(lasttrade), 'yyyy-MM-dd') #
            </td>
        </tr>
        <tr>
            <td class="tdTitle01" style="width:70px" align="center">
                公司名稱
            </td>
            <td class="tdContent02">
                #= (name == null) ? '' : name #
            </td>
            <td class="tdTitle01" style="width:70px" align="center">
                簡稱
            </td>
            <td class="tdContent02">
                #= (sname == null) ? '' : sname #
            </td>
            <td class="tdTitle01" style="width:70px" align="center">
                統一編號
            </td>
            <td class="tdContent02">
                #= (unid == null) ? '' : unid #
            </td>
            <td class="tdTitle01" style="width:90px" align="center">
                公司電話
            </td>
            <td class="tdContent02">
                #= (telephone1 == null) ? '' : telephone1 #
            </td>
        </tr>
        <tr>
            <td class="tdTitle01" style="width:70px" align="center">
                傳真
            </td>
            <td class="tdContent01">
                #= (fax == null) ? '' : fax #
            </td>
            <td class="tdTitle01" style="width:70px" align="center">
                Email(公)
            </td>
            <td class="tdContent01">
                #= (email1 == null) ? '' : email1 #
            </td>
            <td class="tdTitle01" style="width:70px" align="center">
                網址
            </td>
            <td class="tdContent01">
                #= (website == null) ? '' : website #
            </td>
            <td class="tdTitle01" style="width:90px" align="center">
                付款條件
            </td>
            <td class="tdContent01">
                #= (payName == null) ? '' : payName #
            </td>
        </tr>
        <tr>
            <td class="tdTitle01" style="width:70px" align="center">
                負責人
            </td>
            <td class="tdContent02">
                #= (contact1 == null) ? '' : contact1 #
            </td>
            <td class="tdTitle01" style="width:70px" align="center">
                電話
            </td>
            <td class="tdContent02">
                #= (telephone2 == null) ? '' : telephone2 #
            </td>
            <td class="tdTitle01" style="width:70px" align="center">
                Email
            </td>
            <td class="tdContent02">
                #= (email2 == null) ? '' : email2 #
            </td>
            <td class="tdTitle01" style="width:90px" align="center">
                交易幣別
            </td>
            <td class="tdContent02">
                #= (currencyName == null) ? '' : currencyName #
            </td>
        </tr>
        <tr>
            <td class="tdTitle01" style="width:70px" align="center">
                聯絡人
            </td>
            <td class="tdContent01">
                #= (contact2 == null) ? '' : contact2 #
            </td>
            <td class="tdTitle01" style="width:70px" align="center">
                電話
            </td>
            <td class="tdContent01">
                #= (telephone3 == null) ? '' : telephone3 #
            </td>
            <td class="tdTitle01" style="width:70px" align="center">
                Email
            </td>
            <td class="tdContent01">
                #= (email3 == null) ? '' : email3 #
            </td>
            <td class="tdTitle01" style="width:90px" align="center"></td>
            <td class="tdContent01"></td>
        </tr>
        <tr>
            <td class="tdTitle01" style="width:70px" align="center">
                公司地址
            </td>
            <td class="tdContent02" colspan="3">
                #= (address == null) ? '' : address #
            </td>
            <td class="tdTitle01" style="width:70px" align="center">
                送貨地址
            </td>
            <td class="tdContent02" colspan="3">
                #= (shipaddr == null) ? '' : shipaddr #
            </td>
        </tr>
        <tr>
            <td class="tdTitle01" style="width:70px" align="center">
                帳單地址
            </td>
            <td class="tdContent01" colspan="3">
                #= (invoiceaddr == null) ? '' : invoiceaddr #
            </td>
            <td class="tdTitle01" style="width:70px" align="center">
                備註
            </td>
            <td class="tdContent01" colspan="3">
                #= (note == null) ? '' : note #
            </td>
        </tr>
    </table>
</script>
<script>
    var initialLoad = true;
    var customersView_apiUrl = "api/customers";
    var customersViewPhone_apiUrl = "api/customers/phone";
    var customersView_dataSource = new kendo.data.DataSource({
        transport: {
            read: {
                url: customersViewPhone_apiUrl + "/",
                dataType: "json"
            },
            update: {
                url: function (data) {
                    return customersView_apiUrl + "/" + data.id;
                },
                type: "put",
                contentType: "application/json",
                dataType: "json"
            },
            destroy: {
                url: function (data) {
                    return customersView_apiUrl + "/" + data.id;
                },
                type: "delete",
                dataType: "json"
            },
            create: {
                url: customersView_apiUrl,
                type: "post",
                contentType: "application/json",
                dataType: "json"
            },
            parameterMap: function (data, operation) {
                if (operation == "create") {
                    data.id = 0;
                }
                return JSON.stringify(data);
            }
        },
        requestStart: function () {
            if (initialLoad) 
                kendo.ui.progress($("#gridCustomers"), true);
        },
        requestEnd: function () {
            if(initialLoad)
                kendo.ui.progress($("#gridCustomers"), false);
            initialLoad = false;

        },
        batch: false,
        pageSize: 10,
        error: function (err) {
            var message = (err.xhr.responseText == "") ? "" : JSON.parse(err.xhr.responseText).message + "\n";
            alert(err.status + "\n" + message + "將重新載入資料!");
            console.log(err.status + "\n" + message + "將重新載入資料!");
            $('#gridCustomers').data('kendoGrid').dataSource.read();
            $('#gridCustomers').data('kendoGrid').refresh();
        },
        schema: {
            model: {
                id: "id",
                fields: {
                    id: { editable: false, nullable: false },
                    cat: { editable: true },
                    catName: { nullable: true },
                    no: { editable: true, validation: { required: true } },
                    name: { editable: true, validation: { required: true } },
                    sname: { editable: true, validation: { required: true } },
                    unid: { editable: true },
                    contact1: { editable: true, validation: { required: true } },
                    contact2: { editable: true },
                    email1: { editable: true },
                    email2: { editable: true },
                    email3: { editable: true },
                    telephone1: { editable: true },
                    telephone2: { editable: true },
                    telephone3: { editable: true },
                    website: { editable: true },
                    fax: { editable: true },
                    address: { editable: true },
                    shipaddr: { editable: true },
                    Invoiceaddr: { editable: true },
                    pay: { editable: true },
                    payName: { nullable: true },
                    website: { editable: true },
                    fax: { editable: true },
                    address: { editable: true },
                    shipaddr: { editable: true },
                    Invoiceaddr: { editable: true },
                    currency: { editable: true },
                    currencyName: { nullable: true },
                    lasttrade: { editable: true },
                    Note: { editable: true },
                    timestampString: { editable: false }
                }
            }
        }
    });

    $("#gridCustomers").kendoGrid({
        dataSource: customersView_dataSource,
        detailTemplate: kendo.template($("#detailtemplate").html()),
        pageable: true,
        sortable: true,
        height: "600px",
        filterable:
            {
                extra: false,
                operators: {
                    string: {
                        Contains: "包含"
                    }
                }
            },
        toolbar: ["create"],
        columns: [
            { field: "id", hidden: true },
            { field: "catName", title: "類別", width:"80px" },
            { field: "no", title: "編號", width: "100px" },
            { field: "name", title: "名稱" },
            { field: "sname", title: "簡稱", hidden: true },
            { field: "unid", title: "統一編號", hidden: true },
            { field: "fax", title: "公司Fax", hidden: true },
            { field: "email1", title: "公司Email", hidden: true },
            { field: "website", title: "公司網站", hidden: true },
            { field: "Address", title: "公司地址", hidden: true },
            { field: "Shipaddr", title: "送貨地址", hidden: true },
            { field: "Invoiceaddr", title: "發票地址", hidden: true },
            { field: "contact1", title: "負責人", hidden: true },
            { field: "telephone2", title: "負責人電話", hidden: true },
            { field: "email2", title: "負責人Email", hidden: true },
            { field: "contact2", title: "聯絡人" },
            { field: "telephone3", title: "聯絡人電話", width: "150px" },
            { field: "telephone1", title: "公司電話", width: "150px" },
            { field: "Pay", title: "付款條件", hidden: true },
            { field: "Currency", title: "交易幣別", hidden: true },
            { field: "note", title: "備註", hidden: true },
            { command: ["edit", "destroy"], title: "&nbsp;" }
        ],
        editable: {
            mode: "popup",
            window: {
                title: "內容"
            },
            template: kendo.template($("#popup-editor").html()),

            confirmation: "確定刪除?"
        },
        edit: function (e) {
            if (e.model.isNew()) {
                var cat = $("input[name=cat]").data("kendoDropDownList");
                e.model.set("cat", 1);
                var pay = $("input[name=pay]").data("kendoDropDownList");
                e.model.set("pay", 1);
                var currency = $("input[name=currency]").data("kendoDropDownList");
                e.model.set("currency", 1);
            }
        },
    });

</script>